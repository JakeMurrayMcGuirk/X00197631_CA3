trigger:
- master
- development

pool:
  vmImage: 'ubuntu-latest'


stages:
- stage: 'Build'
  jobs:
    - job: 'Build'
      steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.8'
          addToPath: true

      - script: |
          pip install -r dependencies.txt
        displayName: 'Install dependencies'

      - script: |
          pytest tests/test*.py
        displayName: 'Run pytest'

      - script: |
          pytest --cov=app
        displayName: 'Get pytest-cov coverage'

      - script: |
          pylint **/*.py --disable=C
        displayName: 'Run pylint'
        # Below code from https://stackoverflow.com/questions/61710112/azure-devops-pipeline-fails-when-running-pylint
        continueOnError: true

      - script: |
          echo "Building the Python application"
          python -m compileall .
        displayName: 'Build Python App'

      - task: CopyFiles@2
        inputs:
          contents: '**/*.py'
          targetFolder: '$(build.artifactStagingDirectory)'

      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: 'drop'




- stage: SecurityScanning
  displayName: 'Security Scanning'
  dependsOn: 'Build'
  jobs:
  - job: SecurityCheck
    displayName: 'Security Check'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    # Make sure we have full git history so Gitleaks can scan commits
    - checkout: self
      fetchDepth: 0

    # (Optional) still download build artifacts if you need them later
    - task: DownloadBuildArtifacts@0
      displayName: 'Download build outputs'
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'drop'
        downloadPath: '$(System.DefaultWorkingDirectory)'

    # --- Gitleaks: CredScan replacement ---
    - task: Gitleaks@3
      displayName: 'Gitleaks secret scan (CredScan replacement)'
      inputs:
        # Where to scan – normally your source repo
        scanlocation: '$(Build.SourcesDirectory)'

        # Use predefined config with CredScan rules ported in
        configtype: 'predefined'
        predefinedconfigfile: 'GitleaksUdmCombo.toml'
        # Alt: 'UDMSecretChecksv8.toml' for “pure” CredScan rules

        # Scan mode:
        # - 'smart'    -> auto-detect best mode (PR, full, etc.)
        # - 'all'      -> all commits
        # - 'directory'-> only current files (no git history)
        scanmode: 'smart'

        # Task behaviour when secrets are found
        taskfail: false                 # fail the task on findings
        taskfailonexecutionerror: true # fail if Gitleaks crashes

        # Reporting
        reportformat: 'sarif'          # works with SARIF SAST tab
        uploadresults: true
        reportartifactname: 'CodeAnalysisLogs'
        # reportfolder:  # default: agent temp
        # reportname:    # default: gitleaks-<timestamp>.sarif

        # Noise control
        redact: true                   # hide secret values in logs
        verbose: false                 # set true while tuning rules



- stage: DependencySecurity
  displayName: 'Dependency Security Scanning'
  dependsOn: 'SecurityScanning'
  jobs:
  - job: OWASPCheck
    steps:
    - task: dependency-check-build-task@6
      inputs:
        projectName: '$(Build.Repository.Name)'
        scanPath: '$(System.DefaultWorkingDirectory)'
        format: 'HTML'
        uploadReports: true
        uploadSARIFReport: true
        # failOnCVSS: '7' # <-- remove this line to avoid failing the job on high CVSS scores
        nvdApiKey: 'your-nvd-api-key'  # Replace with your API key
        additionalArguments: >
          --disableCentral
          --disableOssIndex


- stage: DeployTest
  displayName: 'Deploy to Test Environment'
  dependsOn: DependencySecurity
  jobs:
  - deployment: DeployToTest
    displayName: 'Deploy to Test'
    environment: test
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "Deploying application to Test environment"
              ls
            displayName: 'Simulate Test Deployment'


- stage: UAT
  displayName: 'User Acceptance Testing'
  dependsOn: DeployTest
  jobs:
  - job: RunUAT
    steps:
    - script: |
        pip install -r dependencies.txt
        behave
      displayName: 'Run Behave UAT tests'
